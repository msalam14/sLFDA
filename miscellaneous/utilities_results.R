# Required packages
library(tidyverse)
library(dplyr)
library(matrixcalc)
library(sn)


# this directory needs to have all the files generated by utilities_estimate.R, utilities_estimate_misclass.R;
# for storage issue original files are not in the git repository. Instead, files generated by this script are available.
dirP<-"miscellaneous/SimStudy_Results/"
dirC<-"miscellaneous/SimStudy_Results/"


# To fixed the points on S
n_s<-51
ss<-seq(0,1,length.out = n_s)

ntp<-20
tp<-matrix(seq(0,1,length.out = ntp+2)[-c(1,ntp+2)],ncol=1)

# Full process time grid
Tg<-seq(0,1,length.out=51)

### TRUE Parameters
# True Mean function
meanPF<-function(s,t){
  2.5+(3.15*s)+(4*t)+(2*s*t)
}

#Scale Function
sFUN<-function(s,t){
  require(mvtnorm)
  25*dmvnorm(c(s,t),mean = c(0,0),sigma=matrix(c(2.5,0.75,0.75,3.5),2,2))
}

## True PLF
TRMean<-sapply(ss, function(s){
  sapply(Tg, function(t){
    meanPF(s = s,t=t)
  })
})

TRScale<-sapply(ss, function(s){
  sapply(Tg, function(t){
    sFUN(s = s,t=t)
  })
})

trALP<-list(
  function(s){
    2e1*(exp(2*s)/(1+exp(2*s)))*sin(6*pi*s/4)
  },
  alFUN<-function(s){
    5*(exp(2*s)/(1+exp(2*s)))-0.5*sin(2*pi*s)
  }
  ,
  alFUN<-function(s){
    0
  }
)
fname<-c("PNS","SN","NRM")
n<-c(100,300,500)
Nsim<-1000
flext<-c(".txt","_s1.txt","_s2.txt",".txt")
for(k in 1:4){
  simse_se_res<-do.call(rbind,lapply(1:length(fname),function(i){
    do.call(rbind,lapply(1:length(n),function(j){
      fln<-paste(dirP,"SkewedFDA/PLF_",fname[i],ifelse(k==4,"_MS_","_"),n[j],flext[k],sep="")
      plf_dat1F<-read.table(fln,header = FALSE)
      plf_dat12<-plf_dat1F %>%
        filter(V55<=unique(plf_dat1F$V55)[Nsim])
      plf_dat1<-plf_dat12 %>% filter(V52<2)
      plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
      do.call(c,lapply(seq_len(length(plf_Par)),function(l){
        plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
        mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
        scale1<-split.data.frame(exp(plf_par[[2]][,1:51]),plf_par[[2]][,52])
        alpha1<-plf_par[[3]][,1:51]
        #########
        # Results for Mean
        Mmean<-Reduce(`+`,mean1)*(1/Nsim)
        Msb<-mean(rowMeans((Mmean-TRMean)^2))
        Mvar<-mean(rowMeans(Reduce(`+`,lapply(mean1, function(u){(u-Mmean)^2}))*(1/(Nsim-1))))
        
        MMse<-sapply(1:Nsim, function(i){
          mean(apply((mean1[[i]]-TRMean)^2,1,mean))
        })
        
        mq1<-mean(MMse); mq2<-var(MMse)/Nsim
        q1<-sqrt(((1/(2*sqrt(mq1)))^2)*mq2)
        
        
        # Results for Scale
        Smean<-Reduce(`+`,scale1)*(1/Nsim)
        Ssb<-mean(rowMeans((Smean-TRScale)^2))
        Svar<-mean(rowMeans(Reduce(`+`,lapply(scale1, function(u){(u-Smean)^2}))*(1/(Nsim-1))))
        
        SMse<-sapply(1:Nsim, function(i){
          mean(apply((scale1[[i]]-TRScale)^2,1,mean))
        })
        sq1<-mean(SMse); sq2<-var(SMse)/Nsim
        q2<-sqrt(((1/(2*sqrt(sq1)))^2)*sq2)
        
        # Results for Shape
        trAlp<-sapply(ss, trALP[[i]])
        
        Amean<-colMeans(alpha1)
        Asb<-mean((Amean-trAlp)^2)
        Avar<-mean(colSums(t(apply(alpha1,1, function(u){(u-Amean)^2})))*(1/(Nsim-1)))
        
        AMse<-sapply(1:Nsim, function(i){
          mean((as.numeric(alpha1[i,])-trAlp)^2)
        })
        
        aq1<-mean(AMse); aq2<-var(AMse)/Nsim
        q3<-sqrt(((1/(2*sqrt(aq1)))^2)*aq2)
        
        c(sqrt(Msb),sqrt(Mvar),sqrt(mq1),q1,sqrt(Ssb),sqrt(Svar),sqrt(sq1),q2,sqrt(Asb),sqrt(Avar),sqrt(aq1),q3)
      }))
    }))
  }))
  
  clnm<-do.call(c,lapply(c("M","S","A"),function(u){paste(u,c("IBIAS","IVAR","IMSE","SE"),sep="")}))
  as.data.frame(simse_se_res) %>%
    set_names(c(paste("S0",clnm,sep=""),paste("S1",clnm,sep=""))) %>%
    mutate(SS=rep(c("100","300","500"),3),
           Scenario=c("Mixed",rep("",2),"Positive",rep("",2),"No",rep("",2))) %>%
    write.table(file=paste(dirP,"simse_se_res",ifelse(k==4,"_MS.txt",flext[k]),sep=""),row.names = FALSE)
  
  
  Qsimse_se_res<-do.call(rbind,lapply(1:length(fname),function(i){
    Tqsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,trALP[[i]](ss[a])),family = "SN"))[3]),family = "SN"))
    })
    TQnt<-list("q05"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[1,]),
               "q10"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[2,]),
               "q90"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[3,]),
               "q95"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[4,]))
    
    do.call(rbind,lapply(1:length(n),function(j){
      ### sLFDA0
      ## Quantile for sLFDA0
      qslfda0_pns100<-read.table(paste(dirP,"SkewedFDA/QsLFDA0_",fname[i],ifelse(k==4,"_MS_","_"),n[j],flext[k],sep=""))
      qslfda100S0<-qslfda0_pns100 %>%filter(V53<=unique(qslfda0_pns100$V53)[Nsim])
      q0slfda100<-qslfda100S0 %>% filter(V52!=0.10)
      Qslfda0<-split.data.frame(q0slfda100[,c(1:51,53)],q0slfda100$V52)
      qslfda0<-do.call(rbind,lapply(seq_len(length(Qslfda0)),function(w){
        qdat<-split.data.frame(Qslfda0[[w]][,1:51],Qslfda0[[w]][52])
        Qmean<-Reduce(`+`,qdat)*(1/Nsim)
        Qsb<-mean(rowMeans((Qmean-TQnt[[w]])^2))
        Qvar<-mean(rowMeans(Reduce(`+`,lapply(qdat, function(u){(u-Qmean)^2}))*(1/(Nsim-1))))
        
        iqv<-sapply(qdat, function(v){mean(apply(((v-TQnt[[w]])^2),1,mean))})
        q1iqv<-mean(iqv); q2iqv<-var(iqv)
        c(sqrt(Qsb),sqrt(Qvar),sqrt(q1iqv),sqrt(((1/(2*sqrt(q1iqv)))^2)*q2iqv))
      }))
      
      
      ### sLFDA1
      ## Quantile for sLFDA1
      qslfda1_pns100<-read.table(paste(dirP,"SkewedFDA/QsLFDA1_",fname[i],ifelse(k==4,"_MS_","_"),n[j],flext[k],sep=""))
      qslfda100S1<-qslfda1_pns100 %>%filter(V53<=unique(qslfda1_pns100$V53)[Nsim])
      q1slfda100<-qslfda100S1 %>% filter(V52!=0.10)
      Qslfda1<-split.data.frame(q1slfda100[,c(1:51,53)],q1slfda100$V52)
      qslfda1<-do.call(rbind,lapply(seq_len(length(Qslfda1)),function(w){
        qdat<-split.data.frame(Qslfda1[[w]][,1:51],Qslfda1[[w]][52])
        Qmean<-Reduce(`+`,qdat)*(1/Nsim)
        Qsb<-mean(rowMeans((Qmean-TQnt[[w]])^2))
        Qvar<-mean(rowMeans(Reduce(`+`,lapply(qdat, function(u){(u-Qmean)^2}))*(1/(Nsim-1))))
        
        iqv<-sapply(qdat, function(v){mean(apply(((v-TQnt[[w]])^2),1,mean))})
        q1iqv<-mean(iqv); q2iqv<-var(iqv)
        c(sqrt(Qsb),sqrt(Qvar),sqrt(q1iqv),sqrt(((1/(2*sqrt(q1iqv)))^2)*q2iqv))
      }))
      
      ### LFDA
      ## Quantile for LFDA
      qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_",fname[i],ifelse(k==4,"_MS_","_"),n[j],flext[k],sep=""))
      qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
      qlfda100<-qlfda100S %>% filter(V52!=0.10)
      Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
      qlfda<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
        qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
        Qmean<-Reduce(`+`,qdat)*(1/Nsim)
        Qsb<-mean(rowMeans((Qmean-TQnt[[w]])^2))
        Qvar<-mean(rowMeans(Reduce(`+`,lapply(qdat, function(u){(u-Qmean)^2}))*(1/(Nsim-1))))
        
        iqv<-sapply(qdat, function(v){mean(apply(((v-TQnt[[w]])^2),1,mean))})
        q1iqv<-mean(iqv); q2iqv<-var(iqv)
        c(sqrt(Qsb),sqrt(Qvar),sqrt(q1iqv),sqrt(((1/(2*sqrt(q1iqv)))^2)*q2iqv))
      }))
      
      ## Nonparametric
      ## Quantile for COBS
      qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_",fname[i],ifelse(k==4,"_MS_","_"),n[j],flext[k],sep=""))
      qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
      qcobs100<-qcobs100S %>% filter(V52!=0.10)
      Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
      qcobs<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
        qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
        Qmean<-Reduce(`+`,qdat)*(1/Nsim)
        Qsb<-mean(rowMeans((Qmean-TQnt[[w]])^2))
        Qvar<-mean(rowMeans(Reduce(`+`,lapply(qdat, function(u){(u-Qmean)^2}))*(1/(Nsim-1))))
        
        iqv<-sapply(qdat, function(v){mean(apply(((v-TQnt[[w]])^2),1,mean))})
        q1iqv<-mean(iqv); q2iqv<-var(iqv)
        c(sqrt(Qsb),sqrt(Qvar),sqrt(q1iqv),sqrt(((1/(2*sqrt(q1iqv)))^2)*q2iqv))
      }))
      
      cbind(qslfda0,qslfda1,qlfda,qcobs,c(5,50,90,95))
    }))
  })) 
  
  as.data.frame(Qsimse_se_res) %>%
    set_names(c(paste("s0q_",c("B","V","M","SE"),sep=""),
                paste("s1q_",c("B","V","M","SE"),sep=""),
                paste("lq_",c("B","V","M","SE"),sep=""),
                paste("cb_",c("B","V","M","SE"),sep=""),"Qntl")) %>%
    mutate(SS=rep(c("100","300","500"),each=4,times=3),
           Scenario=rep(c("Mixed","Positive","No"),each=12)) %>%
    write.table(file=paste(dirC,"qnt_se_res",ifelse(k==4,"_MS.txt",flext[k]),sep=""),row.names = FALSE)
}


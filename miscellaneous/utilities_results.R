
knitr::opts_chunk$set(echo = FALSE)
# required packages
library(tidyverse)
library(dplyr)
library(gridExtra)
library(ggplot2)
library(factoextra)
library(glmnet)
library(rsvd)
library(ggpubr)
library(matrixcalc)
library(mgcv)
library(sn)
library(refund)
library(mvtnorm)
library(fda)

# direcotry where the 36 files generated by utilities_estimate.R file generates
dirP<-"SimStudy_Results"
dirC<-"SimStudy_Results"


# To fixed the points on S
n_s<-51
ss<-seq(0,1,length.out = n_s)

# PLF functions
# True Mean function
meanPF<-function(s,t){
  2.5+(3.15*s)+(4*t)+(2*s*t)
}

#Scale Function
sFUN<-function(s,t){
  require(mvtnorm)
  25*dmvnorm(c(s,t),mean = c(0,0),sigma=matrix(c(2.5,0.75,0.75,3.5),2,2))
}

#Shape Function

alFUN<-function(s){
  2e1*(exp(2*s)/(1+exp(2*s)))*sin(6*pi*s/4)
}

# Testing 
ntp<-20
tp<-matrix(seq(0,1,length.out = ntp+2)[-c(1,ntp+2)],ncol=1)
#' Epanechnikov Kernel function
#' 
#' @param x point at which kernel will be evaluated
#' @export
depan<-function(x){
  ifelse(abs(x)<=1,(3/4)*(1-x^2),0)
}

## Prediction time points
TGrid<-seq(0,1,length.out=1001)
# Full process time grid
Tg<-seq(0,1,length.out=51)


### TRUE Parameters
## True PLF
TRMean<-sapply(ss, function(s){
  sapply(Tg, function(t){
    meanPF(s = s,t=t)
  })
})

TRScale<-sapply(ss, function(s){
  sapply(Tg, function(t){
    sFUN(s = s,t=t)
  })
})

TRAlp<-sapply(ss, function(s){alFUN(s)})



n<-100
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_PNS_100.txt",sep=""),header = FALSE)

plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf1res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf1res<-rbind(Mres,Sres,Ares)
  plf1res
}))
plf1res<-plf1res[,c(1,2,3,8,4,9,5,10)]



n<-100
Nsim<-1000
Tqsk<-sapply(1:length(ss),function(a){
  qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,TRAlp[a]),family = "SN"))[3]),family = "SN"))
})
TQnt<-list("q05"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[1,]),
           "q10"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[2,]),
           "q90"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[3,]),
           "q95"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[4,]))

#plf_dat1<-read.table("SkewedFDSS/PLF_PNS_100.txt",header = FALSE)
#plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
q1res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_PNS_100.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res1<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q1res<-cbind(q1res,lfda_res1)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_PNS_100.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res1<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q1res<-cbind(q1res,cobs_res1)



n<-300
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_PNS_300.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf2res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf2res<-rbind(Mres,Sres,Ares)
  plf2res
}))
plf2res<-plf2res[,c(1,2,3,8,4,9,5,10)]



#quantile
q2res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_PNS_300.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res2<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q2res<-cbind(q2res,lfda_res2)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_PNS_300.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res2<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q2res<-cbind(q2res,cobs_res2)



n<-500
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_PNS_500.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf3res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf3res<-rbind(Mres,Sres,Ares)
  plf3res
}))
plf3res<-plf3res[,c(1,2,3,8,4,9,5,10)]



## quantile
q3res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_PNS_500.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res3<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q3res<-cbind(q3res,lfda_res3)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_PNS_500.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res3<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q3res<-cbind(q3res,cobs_res3)



plf_pns<-plf1res %>%add_case(plf2res) %>%add_case(plf3res) %>%mutate(Param=recode(PLF,"Mean"=1,"Scale"=2,"Alpha"=3)) %>%arrange(Param) %>% dplyr::select(-Param) %>% mutate_at(vars(-PLF,-SS),funs(round(.,3)))
#plf_pns%>% kableExtra::kbl(caption = "Simulation results for PLF when skewness is positive on some sub-intervals of the functional domain and is negative on the others.",row.names = FALSE) %>% kableExtra::kable_classic_2()



Qpns<-data.frame(q1res) %>%add_case(data.frame(q2res)) %>%add_case(data.frame(q3res)) %>%mutate(Quantile=as.character(rep(c(5,50,90,95),times=3)),SS=as.character(rep(c(100,300,500),each=4))) %>% dplyr::select(Quantile,SS,X1:X12)



alFUN<-function(s){
  5*(exp(2*s)/(1+exp(2*s)))-0.5*sin(2*pi*s)
}
TRAlp<-sapply(ss, function(s){alFUN(s)})
n<-100
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_SN_100.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf1res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf1res<-rbind(Mres,Sres,Ares)
}))
plf1res<-plf1res[,c(1,2,3,8,4,9,5,10)]



n<-100
Nsim<-1000
Tqsk<-sapply(1:length(ss),function(a){
  qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,TRAlp[a]),family = "SN"))[3]),family = "SN"))
})
TQnt<-list("q05"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[1,]),
           "q10"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[2,]),
           "q90"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[3,]),
           "q95"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[4,]))

q1res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_SN_100.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res1<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q1res<-cbind(q1res,lfda_res1)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_SN_100.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res1<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q1res<-cbind(q1res,cobs_res1)



n<-300
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_SN_300.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf2res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf2res<-rbind(Mres,Sres,Ares)
  plf2res
}))
plf2res<-plf2res[,c(1,2,3,8,4,9,5,10)]



#quantile
q2res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_SN_300.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res2<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q2res<-cbind(q2res,lfda_res2)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_SN_300.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res2<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q2res<-cbind(q2res,cobs_res2)



n<-500
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_SN_500.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf3res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf3res<-rbind(Mres,Sres,Ares)
  plf3res
}))
plf3res<-plf3res[,c(1,2,3,8,4,9,5,10)]



#quantile
q3res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_SN_500.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res3<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q3res<-cbind(q3res,lfda_res3)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_SN_500.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res3<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q3res<-cbind(q3res,cobs_res3)



plf_sn<-plf1res %>%add_case(plf2res) %>%add_case(plf3res) %>%mutate(Param=recode(PLF,"Mean"=1,"Scale"=2,"Alpha"=3)) %>%arrange(Param) %>% dplyr::select(-Param) %>% mutate_at(vars(-PLF,-SS),funs(round(.,3)))
#plf_sn%>% kableExtra::kbl(caption = "Simulation results for PLF when skewness is positive on some sub-intervals of the functional domain and is negative on the others.",row.names = FALSE) %>% kableExtra::kable_classic_2()



Qsn<-data.frame(q1res) %>%add_case(data.frame(q2res)) %>%add_case(data.frame(q3res)) %>%mutate(Quantile=as.character(rep(c(5,50,90,95),times=3)),SS=as.character(rep(c(100,300,500),each=4))) %>% dplyr::select(Quantile,SS,X1:X12)



alFUN<-function(s){
  0
}
TRAlp<-sapply(ss, function(s){alFUN(s)})

n<-100
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_NRM_100.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)

plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf1res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf1res<-rbind(Mres,Sres,Ares)
  plf1res
}))
plf1res<-plf1res[,c(1,2,3,8,4,9,5,10)]



n<-100
Nsim<-1000
Tqsk<-sapply(1:length(ss),function(a){
  qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,TRAlp[a]),family = "SN"))[3]),family = "SN"))
})
TQnt<-list("q05"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[1,]),
           "q10"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[2,]),
           "q90"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[3,]),
           "q95"=TRMean+TRScale*outer(rep(1,nrow(TRScale)),Tqsk[4,]))

q1res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_NRM_100.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res1<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q1res<-cbind(q1res,lfda_res1)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_NRM_100.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res1<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q1res<-cbind(q1res,cobs_res1)



n<-300
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_NRM_300.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)

plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf2res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf2res<-rbind(Mres,Sres,Ares)
  plf2res
}))
plf2res<-plf2res[,c(1,2,3,8,4,9,5,10)]



#Quantile
q2res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_NRM_300.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res2<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q2res<-cbind(q2res,lfda_res2)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_NRM_300.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res2<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q2res<-cbind(q2res,cobs_res2)



n<-500
Nsim<-1000
plf_dat1F<-read.table(paste(dirP,"SkewedFDA/PLF_NRM_500.txt",sep=""),header = FALSE)
plf_dat12<-plf_dat1F %>% filter(V55<=unique(plf_dat1F$V55)[Nsim])
plf_dat1<-plf_dat12 %>% filter(V52<2)
plf_Par<-split.data.frame(plf_dat1[,-52],plf_dat1$V52)
plf3res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  #########
  # Results for Mean
  MEMean<-Reduce(`+`,lapply(1:Nsim, function(i){
    mean1[[i]]/Nsim
  }))
  
  MEMean2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-MEMean)^2
  }))
  
  MMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (mean1[[i]]-TRMean)^2/Nsim
  }))
  
  MIBias<-sqrt(mean(apply((MEMean-TRMean)^2,1,mean)))
  MIVar<-sqrt(mean(apply(MEMean2*(1/(Nsim-1)),1,mean)))
  mIMSE<-sqrt(mean(apply(MMse,1,mean)))
  
  Mres<-data.frame("PLF"="Mean","SS"=n,"ISBias"=MIBias,"IVar"=MIVar,"IMSE"=mIMSE)
  
  # Results for Scale
  MEScl<-Reduce(`+`,lapply(1:Nsim, function(i){
    scale1[[i]]/Nsim
  }))
  
  MEScl2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-MEScl)^2
  }))
  
  SMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    (scale1[[i]]-TRScale)^2/Nsim
  }))
  
  SIBias<-sqrt(mean(apply((MEScl-TRScale)^2,1,mean)))
  SIVar<-sqrt(mean(apply(MEScl2*(1/(Nsim-1)),1,mean)))
  sIMSE<-sqrt(mean(apply(SMse,1,mean)))
  
  Sres<-data.frame("PLF"="Scale","SS"=n,"ISBias"=SIBias,"IVar"=SIVar,"IMSE"=sIMSE)
  
  # Results for Mean
  MEAlp<-Reduce(`+`,lapply(1:Nsim, function(i){
    alpha1[i,]/Nsim
  }))
  
  MEAlp2<-Reduce(`+`,lapply(1:Nsim, function(i){
    (alpha1[i,]-MEAlp)^2
  }))
  
  AMse<-Reduce(`+`,lapply(1:Nsim, function(i){
    ((alpha1[i,]-TRAlp)^2)/Nsim
  }))
  
  AIBias<-sqrt(mean(as.numeric((MEAlp-TRAlp)^2)))
  AIVar<-sqrt(mean(as.numeric(MEAlp2)*(1/(Nsim-1))))
  aIMSE<-sqrt(mean(as.numeric(AMse)))
  
  
  Ares<-data.frame("PLF"="Alpha","SS"=n,"ISBias"=AIBias,"IVar"=AIVar,"IMSE"=aIMSE)
  #write.csv(rbind(Mres,Sres,Ares),file = paste("PLFres_PNS_",n,".csv",sep=""),row.names = FALSE)
  plf3res<-rbind(Mres,Sres,Ares)
  plf3res
}))
plf3res<-plf3res[,c(1,2,3,8,4,9,5,10)]



#quantile
q3res<-do.call(cbind,lapply(seq_len(length(plf_Par)),function(l){
  plf_par<-split.data.frame(plf_Par[[l]][,c(1:51,54)],plf_Par[[l]]$V53)
  mean1<-split.data.frame(plf_par[[1]][,1:51],plf_par[[1]][,52])
  scale1<-split.data.frame(plf_par[[2]][,1:51],plf_par[[2]][,52])
  alpha1<-plf_par[[3]][,1:51]
  Qnt<-lapply(1:Nsim,function(i){
    qsk<-sapply(1:length(ss),function(a){
      qsn(c(0.05,0.50,0.90,0.95),dp=cp2dp(c(0,1,as.numeric(dp2cp(c(0,1,alpha1[i,a]),family = "SN"))[3]),family = "SN"))
    })
    list("q05"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[1,]),
         "q10"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[2,]),
         "q90"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[3,]),
         "q95"=mean1[[i]]+scale1[[i]]*outer(rep(1,nrow(scale1[[i]])),qsk[4,]))
  })
  #Mean of quantile
  MQnt5<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q05}))/Nsim
  MQnt10<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q10}))/Nsim
  MQnt90<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q90}))/Nsim
  MQnt95<-Reduce(`+`,lapply(1:Nsim, function(i){Qnt[[i]]$q95}))/Nsim
  # Variance of quantile
  VQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-MQnt5)^2}))/(Nsim-1),1,mean)))
  VQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-MQnt10)^2}))/(Nsim-1),1,mean)))
  VQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-MQnt90)^2}))/(Nsim-1),1,mean)))
  VQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-MQnt95)^2}))/(Nsim-1),1,mean)))
  # IMSE
  IMQnt5<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q05-TQnt[[1]])^2}))/Nsim,1,mean)))
  IMQnt10<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q10-TQnt[[2]])^2}))/Nsim,1,mean)))
  IMQnt90<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q90-TQnt[[3]])^2}))/Nsim,1,mean)))
  IMQnt95<-sqrt(mean(apply(Reduce(`+`,lapply(1:Nsim, function(i){(Qnt[[i]]$q95-TQnt[[4]])^2}))/Nsim,1,mean)))
  BQnt5<-sqrt(mean(apply((MQnt5-TQnt[[1]])^2,1,mean)))
  BQnt10<-sqrt(mean(apply((MQnt10-TQnt[[2]])^2,1,mean)))
  BQnt90<-sqrt(mean(apply((MQnt90-TQnt[[3]])^2,1,mean)))
  BQnt95<-sqrt(mean(apply((MQnt95-TQnt[[4]])^2,1,mean)))
  cbind(c(BQnt5,BQnt10,BQnt90,BQnt95),
        c(VQnt5,VQnt10,VQnt90,VQnt95),
        c(IMQnt5,IMQnt10,IMQnt90,IMQnt95))
}))



## Quantile for LFDA
qlfda_pns100<-read.table(paste(dirP,"SkewedFDA/QLFDA_NRM_500.txt",sep = ""))
qlfda100S<-qlfda_pns100 %>%filter(V53<=unique(qlfda_pns100$V53)[Nsim])
qlfda100<-qlfda100S %>% filter(V52!=0.10)
Qlfda<-split.data.frame(qlfda100[,c(1:51,53)],qlfda100$V52)
lfda_res3<-do.call(rbind,lapply(seq_len(length(Qlfda)),function(w){
  qdat<-split.data.frame(Qlfda[[w]][,1:51],Qlfda[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q3res<-cbind(q3res,lfda_res3)



## Quantile for COBS
qcobs_pns100<-read.table(paste(dirC,"SkewedFDA/QCOBS_NRM_500.txt",sep = ""))
qcobs100S<-qcobs_pns100 %>%filter(V53<=unique(qcobs_pns100$V53)[Nsim])
qcobs100<-qcobs100S %>% filter(V52!=0.10)
Qcobs<-split.data.frame(qcobs100[,c(1:51,53)],qcobs100$V52)
cobs_res3<-do.call(rbind,lapply(seq_len(length(Qcobs)),function(w){
  qdat<-split.data.frame(Qcobs[[w]][,1:51],Qcobs[[w]][52])
  mqdat<-Reduce(`+`,qdat)/Nsim
  bqdat<-sqrt(mean(apply((mqdat-TQnt[[w]])^2,1,mean)))
  vqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-mqdat)^2}))/(Nsim-1),1,mean)))
  msqdat<-sqrt(mean(apply(Reduce(`+`,lapply(qdat, function(v){(v-TQnt[[w]])^2}))/(Nsim),1,mean)))
  c(bqdat,vqdat,msqdat)
}))
####
q3res<-cbind(q3res,cobs_res3)



plf_nrm<-plf1res %>%add_case(plf2res) %>%add_case(plf3res) %>%mutate(Param=recode(PLF,"Mean"=1,"Scale"=2,"Alpha"=3)) %>%arrange(Param) %>% dplyr::select(-Param) %>% mutate_at(vars(-PLF,-SS),funs(round(.,3)))
#plf_nrm%>% kableExtra::kbl(caption = "Simulation results for PLF when skewness is positive on some sub-intervals of the functional domain and is negative on the others.",row.names = FALSE) %>% kableExtra::kable_classic_2()



Qnrm<-data.frame(q1res) %>%add_case(data.frame(q2res)) %>%add_case(data.frame(q3res)) %>%mutate(Quantile=as.character(rep(c(5,50,90,95),times=3)),SS=as.character(rep(c(100,300,500),each=4))) %>% dplyr::select(Quantile,SS,X1:X12)



plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns) %>% mutate(Skewness=c(rep(c("No",rep("",2)),3),rep(c("Positive",rep("",2)),3),rep(c("Mixed",rep("",2)),3))) %>%
  write.table(file=paste(dirC,"plf_res_all.txt",sep=""),row.names = FALSE,col.names = FALSE)



## plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns) %>%filter(PLF=="Mean") %>% dplyr::select(-PLF) %>%mutate(Skewness=c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),SS=as.character(SS),Blank1="",Blank2="") %>%
##   write.table(file=paste(dirC,"plf_res_mean.txt",sep=""),row.names = FALSE,col.names = FALSE)



## plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns) %>%filter(PLF=="Scale") %>% dplyr::select(-PLF) %>%mutate(Skewness=c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),SS=as.character(SS),Blank1="",Blank2="") %>%
##   write.table(file=paste(dirC,"plf_res_scale.txt",sep=""),row.names = FALSE,col.names = FALSE)



## plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns) %>%filter(PLF=="Alpha") %>% dplyr::select(-PLF) %>%mutate(Skewness=c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),SS=as.character(SS),Blank1="",Blank2="") %>%
##   write.table(file=paste(dirC,"plf_res_alpha.txt",sep=""),row.names = FALSE,col.names = FALSE)



plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns) %>%filter(PLF=="Mean") %>% dplyr::select(-PLF) %>%mutate(Skewness=c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),
                                                                                                          SS=as.character(SS),Blank1="",Blank2="") %>%
  mutate("$\\sqrt{ISBIAS_0}$"=ISBias,"$\\sqrt{ISBIAS_1}$"=ISBias.1) %>%
  mutate("$\\sqrt{IVAR_0}$"=IVar,"$\\sqrt{IVAR_1}$"=IVar.1) %>%
  mutate("$\\sqrt{IMSE_0}$"=IMSE,"$\\sqrt{IMSE_1}$"=IMSE.1) %>%
  dplyr::select(Skewness=Skewness,SS=SS,
                "$\\sqrt{ISBIAS_0}$"="$\\sqrt{ISBIAS_0}$","$\\sqrt{ISBIAS_1}$"="$\\sqrt{ISBIAS_1}$",
                Blank1,
                "$\\sqrt{IVAR_0}$"="$\\sqrt{IVAR_0}$","$\\sqrt{IVAR_1}$"="$\\sqrt{IVAR_1}$",
                Blank2,
                "$\\sqrt{IMSE_0}$"="$\\sqrt{IMSE_0}$","$\\sqrt{IMSE_1}$"="$\\sqrt{IMSE_1}$")%>%
  mutate_if(is.numeric,function(x) {
    formatC(x, digits = 3, format = "f", drop0trailing = FALSE)
  }) %>%
  kableExtra::kbl(caption = "Simulation results related to the estimation of $\\mu(s,t)$ by the local linear MLE at different sample sizes.",row.names = FALSE,col.names = c("Skewness","SS","$sLFDA_0$","$sLFDA_1$","","$sLFDA_0$","$sLFDA_1$","","$sLFDA_0$","$sLFDA_1$"),align = "r") %>% kableExtra::kable_classic_2() %>%kableExtra::add_header_above(c("","","$\\sqrt{ISBIAS}$"=2,"","$\\sqrt{ISVAR}$"=2,"","$\\sqrt{IMSE}$"=2))



plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns)  %>%filter(PLF=="Scale") %>% dplyr::select(-PLF) %>%mutate(Skewness=c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),
                                                                                                            SS=as.character(SS),Blank1="",Blank2="") %>%
  mutate("$\\sqrt{ISBIAS_0}$"=ISBias,"$\\sqrt{ISBIAS_1}$"=ISBias.1) %>%
  mutate("$\\sqrt{IVAR_0}$"=IVar,"$\\sqrt{IVAR_1}$"=IVar.1) %>%
  mutate("$\\sqrt{IMSE_0}$"=IMSE,"$\\sqrt{IMSE_1}$"=IMSE.1) %>%
  dplyr::select(Skewness=Skewness,SS=SS,
                "$\\sqrt{ISBIAS_0}$"="$\\sqrt{ISBIAS_0}$","$\\sqrt{ISBIAS_1}$"="$\\sqrt{ISBIAS_1}$",
                Blank1,
                "$\\sqrt{IVAR_0}$"="$\\sqrt{IVAR_0}$","$\\sqrt{IVAR_1}$"="$\\sqrt{IVAR_1}$",
                Blank2,
                "$\\sqrt{IMSE_0}$"="$\\sqrt{IMSE_0}$","$\\sqrt{IMSE_1}$"="$\\sqrt{IMSE_1}$")%>%
  mutate_if(is.numeric,function(x) {
    formatC(x, digits = 3, format = "f", drop0trailing = FALSE)
  }) %>%
  kableExtra::kbl(caption = "Simulation results related to the estimation of $\\sigma(s,t)$ by the local linear MLE at different sample sizes.",row.names = FALSE,col.names = c("Skewness","SS","$sLFDA_0$","$sLFDA_1$","","$sLFDA_0$","$sLFDA_1$","","$sLFDA_0$","$sLFDA_1$"),align = "r") %>% kableExtra::kable_classic_2() %>%kableExtra::add_header_above(c("","","$\\sqrt{ISBIAS}$"=2,"","$\\sqrt{ISVAR}$"=2,"","$\\sqrt{IMSE}$"=2))



plf_nrm %>%add_case(plf_sn) %>%add_case(plf_pns)  %>%filter(PLF=="Alpha") %>% dplyr::select(-PLF) %>%mutate(Skewness=c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),
                                                                                                            SS=as.character(SS),Blank1="",Blank2="") %>%
  mutate("$\\sqrt{ISBIAS_0}$"=ISBias,"$\\sqrt{ISBIAS_1}$"=ISBias.1) %>%
  mutate("$\\sqrt{IVAR_0}$"=IVar,"$\\sqrt{IVAR_1}$"=IVar.1) %>%
  mutate("$\\sqrt{IMSE_0}$"=IMSE,"$\\sqrt{IMSE_1}$"=IMSE.1) %>%
  dplyr::select(Skewness=Skewness,SS=SS,
                "$\\sqrt{ISBIAS_0}$"="$\\sqrt{ISBIAS_0}$","$\\sqrt{ISBIAS_1}$"="$\\sqrt{ISBIAS_1}$",
                Blank1,
                "$\\sqrt{IVAR_0}$"="$\\sqrt{IVAR_0}$","$\\sqrt{IVAR_1}$"="$\\sqrt{IVAR_1}$",
                Blank2,
                "$\\sqrt{IMSE_0}$"="$\\sqrt{IMSE_0}$","$\\sqrt{IMSE_1}$"="$\\sqrt{IMSE_1}$")%>%
  mutate_if(is.numeric,function(x) {
    formatC(x, digits = 3, format = "f", drop0trailing = FALSE)
  }) %>%
  kableExtra::kbl(caption = "Simulation results related to the estimation of $\\alpha(s)$ by the local linear MLE at different sample sizes.",row.names = FALSE,col.names = c("Skewness","SS","$sLFDA_0$","$sLFDA_1$","","$sLFDA_0$","$sLFDA_1$","","$sLFDA_0$","$sLFDA_1$"),align = "r") %>% kableExtra::kable_classic_2() %>%kableExtra::add_header_above(c("","","$\\sqrt{ISBIAS}$"=2,"","$\\sqrt{ISVAR}$"=2,"","$\\sqrt{IMSE}$"=2))



Qnrm %>%add_case(Qsn) %>%add_case(Qpns) %>%
  mutate(Skewness=c(rep(c("No",""),c(4,8)),rep(c("Positive",""),c(4,8)),rep(c("Mixed",""),c(4,8)))) %>%
  write.table(file=paste(dirC,"quant_res_all.txt",sep=""),row.names = FALSE,col.names = FALSE)



Qnrm %>%add_case(Qsn) %>%add_case(Qpns) %>%
  filter(Quantile!="5") %>% 
  arrange(Quantile) %>%
  dplyr::select(-Quantile) %>%
  mutate(Skewness=rep(c("No",rep("",2),"Positive",rep("",2),"Mixed",rep("",2)),3)) %>%
  mutate(Quantile=c("$q_{0.50}(s,t)$",rep("",8),"$q_{0.90}(s,t)$",rep("",8),"$q_{0.95}(s,t)$",rep("",8)),
         Blank1="",Blank2="") %>%
  dplyr::select(Quantile=Quantile,Skewness=Skewness,SS=SS,X1,X4,X7,X10,Blank1,X2,X5,X8,X11,Blank2,X3,X6,X9,X12) %>%
  mutate_if(is.numeric,function(x) {
    formatC(x, digits = 3, format = "f", drop0trailing = FALSE)
  }) %>%
  kableExtra::kbl(caption = "Simulation results related to the estimation of $q_{0.50}(s,t)$, $q_{0.90}(s,t)$ and $q_{0.95}(s,t)$  by the local linear MLE at different sample sizes.",row.names = FALSE,col.names = c("Quantile","Skewness","SS","$sLFDA_0$","$sLFDA_1$","LFDA","COBS","","$sLFDA_0$","$sLFDA_1$","$LFSA$","COBS","","$sLFDA_0$","$sLFDA_1$","LFDA","COBS"),align = "r") %>% kableExtra::kable_classic_2() %>%kableExtra::add_header_above(c("","","","$\\sqrt{ISBIAS}$"=4,"","$\\sqrt{ISVAR}$"=4,"","$\\sqrt{IMSE}$"=4))



n<-100
Nsim<-1000
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_PNS_100.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_pns1<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



n<-300
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_PNS_300.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_pns2<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



n<-500
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_PNS_500.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_pns3<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



ipe_pns<-cbind(c(100,300,500),rbind(ipe_pns1,ipe_pns2,ipe_pns3))



n<-100
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_SN_100.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_sn1<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



n<-300
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_SN_300.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_sn2<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



n<-500
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_SN_500.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_sn3<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



ipe_sn<-cbind(c(100,300,500),rbind(ipe_sn1,ipe_sn2,ipe_sn3))



n<-100
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_NRM_100.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_nrm1<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



n<-300
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_NRM_300.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_nrm2<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



n<-500
ipe_dat1F<-read.table(paste(dirP,"SkewedFDA/IPE_NRM_500.txt",sep=""),header = FALSE)
ipe_dat1 <- ipe_dat1F %>% filter(V13<=unique(ipe_dat1F$V13)[Nsim])
ipe_data1<-sqrt(ipe_dat1[,-c(13,14,15)])
ipe_nrm3<-paste(formatC(x=apply(ipe_data1,2,mean),digits = 3,format = "f",drop0trailing = FALSE),"(",formatC(x=apply(ipe_data1,2,sd)/sqrt(Nsim),digits=3,format="f",drop0trailing = FALSE),")",sep="")



ipe_nrm<-cbind(c(100,300,500),rbind(ipe_nrm1,ipe_nrm2,ipe_nrm3))



ipe_res<-rbind(ipe_nrm,ipe_sn,ipe_pns)
as.data.frame(ipe_res) %>%mutate(Skewness=c("No","","","Positive","","","Mixed","","")) %>% dplyr::select(Skewness=Skewness,V1,V4,V2,V6,V5,V3,V7) %>% kableExtra::kbl(caption = "Integrated prediction error by sLFDA and LFDA for prediction at next time and full processes under different skeweness types.",row.names = FALSE,col.names = c("Skewness","SS","$sLFDA_0$","$sLFDA_1$","$LFDA$","$sLFDA_0$","$sLFDA_1$","$LFDA$"),align = "r") %>% kableExtra::kable_classic_2() %>% kableExtra::add_header_above(c("","","$\\sqrt{IPE_N}$"=3,"$\\sqrt{IPE}$"=3))



ipe_res<-rbind(ipe_nrm,ipe_sn,ipe_pns)
as.data.frame(ipe_res) %>%mutate(Skewness=c("No","","","Positive","","","Mixed","","")) %>% dplyr::select(Skewness=Skewness,V1,V9,V8,V12,V11,V10,V13) %>% kableExtra::kbl(caption = "Integrated prediction error by sLFDA and LFDA for prediction at next time and full processes under different skeweness types.",row.names = FALSE,col.names = c("Skewness","SS","$sLFDA_0$","$sLFDA_1$","$LFDA$","$sLFDA_0$","$sLFDA_1$","$LFDA$"),align = "r") %>% kableExtra::kable_classic_2() %>% kableExtra::add_header_above(c("","","$\\sqrt{IPE_N}$"=3,"$\\sqrt{IPE}$"=3))

